+++
categories = ["Mac"]
author = "frostwong"
date = "2016-08-09T14:57:11+08:00"
description = "如果你还在因为使用ssh而窝火，看看这篇短文吧"
draft = false
isCJKLanguage = true
keywords = ["ssh"]
tags = ["mac"]
title = "使用ssh-config提升你的生产力"
type = "post"

+++

我们做服务端开发的，每天最烦心的事情可能就是登陆各种服务器了。在Windows上还好，有SecureCRT还有XShell这种很强大的工具可以用，但在Mac下面选择就很少了。SecureCRT我个人感觉远远不如Windows下的稳定，而渲染效果我当然还是最喜欢iTerm了。其实并没有用到它的很强大的那些功能，比如窗口分割、全局查找等等，最能打动我的其实是智能复制粘贴。不多说了，下面说一下怎样用ssh的config文件来记住登录账户。

## 常规的解决方案
我们最习惯用已知的知识来解决新问题。所以当然你会在.bashrc中添加一条`alias dev='ssh root@10.69.41.41'`这种命令了——注意，这个指令在多数环境中其实是不适用的，因为还面临通道机——最让开发头痛的东西。

所以让我们来发掘一下ssh的强大威力。

## 用ssh config提高效率

### 可以直连的机器
如果可以直连一台机器，比如我的192.168.1.104虚拟机，那就可以在`.ssh/config`中添加一段记录


```
Host debian
	Hostname 192.168.1.104
	Port 22
	User frost
```

不需重启，现在执行`ssh debian`就可以连接debian机器了。  
那么问题来了，通常来说，Linux环境中是找不到明文存储的密码的，这里也不例外，肯定不会让你把密码直接写在这个配置文件中。要实现重新打开一个标签连接同一台机器不需要重新输密码，有两种方式。  
#### 1. 用key登录
具体操作这里不展开，这里只需要把key的路径加在配置文件里即可。

```
Host debian
	Hostname 192.168.1.104
	IdentityFile ~/.ssh/coolio.example.key
	Port 22
	User frost
```

即可。这是最简单直接的方式。  
#### 2. 模拟SecureCRT的『复制会话』功能
也就是说，在一个标签登录了一台机器之后，会在本地保存一份该会话的标识文件。当重新连接这个机器时，会使用这个临时文件当做认证，直接登录而无需验证。局限是如果重启了终端，就需要重新输入一次密码。  
要实现这个功能，只需要在`.ssh/config`里加入这样一段

```
Host *
ControlMaster auto
ControlPath ~/.ssh/master-%r@%h:%p
```

你可能要问了，key那么方便，为什么需要这样呢？这是因为我们认为key已经很安全了，但安全组的同事可能觉得也没那么安全，他们希望我们用安全性更高的静态密码+动态口令的方式登录跳板机，而且跳板机是无法存储任何文件的，无法实现保存key。

### 无法直连的机器
前面提到了跳板机，登录到跳板机当然不是目的，还要登录各种各样的机器，如果我要经常登录一台跳板机后的机器，难道要每次都先登录跳板机（虽然不用每次都输入密码）然后再手工跳转到另一台机器？当然不是。这里要引入『本地端口转发』的概念。
说白了就是我们指定一个本地端口，往这个端口发送的所有数据都会通过**跳板机**被转发到另外一台机器的指定端口。注意两个指定端口不需要是一样的。比如我希望通过本地的2222端口来登录一台开发机的22端口。就需要这样配置一个隧道

```
Host tunnel
	HostName 10.0.0.2
	LocalForward 2222 10.30.43.23:22
	User frost
```

这样执行`ssh -f -N tunnel`就会建立这条本地端口转发的隧道。其实还需要一段配置

```
Host dev
	HostName 127.0.0.1
	Port 2222
	User root
```

当然，看到`ssh -f -N tunnel`这条这么长的指令还是不爽，这时就可以用alias来简化输入了。

### 服务器和本地传输文件
其实用SecureCRT或者XShell还有一个很重要的原因是二者对lrzsz这个小工具的支持很好，而几乎所有的终端工具都存在各种问题，iTerm2也不例外。虽然也可以有workaround来解决，但毕竟不是原生，不好用。我也纠结了很久，原来Mac上没有相应的工具是因为真的不需要啊。  
现在跟我一起做，比如我们前面已经配了一个可以本地直连的远程机器debian，当需要传输文件的时候只需要在本地命令窗口打开`sftp debian`就会打开一个交互的shell。那么不要怕，虽然它有很多命令，但我觉得简单的使用只需要记住4组命令就好了，而且其中3组是原来就会的。  
首先要知道本地和远程的概念，因为你执行了这个命令之后其实已经登陆了了远程机器了，只不过不在bash里面，所以现在你要操作本地的东西时，所有命令都要加上`l`也就是local，而远程的就什么都不加了。  
所以记住下面几个命令：

1. `lpwd` 查看本地机器当前所在目录
2. `pwd` 查看远程机器当前所在目录
3.  `lls` 查看本地机器当前目录下的文件列表
4. `ls` 查看远程机器当前目录下的文件列表
5. `lcd dir` 在本地切换到目标目录
6. `cd dir` 在远程主机上切换到目标目录
7. `put filename` 把本地的文件放在远程主机的当前位置
8. `get filename` 把远程机器上的目录下载到本地当前位置

这和SecureCRT的实现方式是完全一样的，XShell好封装了一个两栏的文件管理器呢，这样看来XShell真的是业界良心。

有人可能会说用expect来实现密码自动填充也是极好的。这个问题，见仁见智吧，至少用了一段时间之后我是不喜欢用expect了，最主要的问题在于窗口的自动缩放，就不展开说了。


